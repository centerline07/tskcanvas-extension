## Copied to takcanvas repo 
# tskcanvas Browser Extension

> Save all open browser tabs as a new tree in tskcanvas with one click.
>
> **Move this file** to the `tskcanvas-extension` repo as `README.md` or `docs/README.md`

---

## Overview

A lightweight browser extension that:
1. Captures all open tabs in the current browser window
2. Authenticates with the same Clerk app as tskcanvas.com (via Sync Host)
3. Sends tabs to the tskcanvas Convex backend
4. Creates a hierarchical tree with each tab as a task

### User Flow
1. User clicks extension icon in browser toolbar
2. Extension prompts for tree name (defaults to "Saved Tabs - [Date]")
3. All open tabs are captured
4. A new tree is created with proper hierarchy
5. User sees success notification with link to view tree

---

## Tech Stack

| Component | Technology | Notes |
|-----------|------------|-------|
| **Framework** | Manifest V3 | Required for Chrome (2024+) |
| **Build Tool** | **Plasmo** (recommended) | Better DX than CRXJS |
| **Auth** | `@clerk/chrome-extension` v2+ | Sync Host for seamless auth |
| **UI** | React + Clerk hooks | `ClerkProvider`, `useClerk`, `useUser` |
| **Cross-browser** | WebExtension Polyfill | For Firefox/Edge support |

---

## Quick Start

```bash
# Create with Plasmo (recommended)
npm create plasmo@latest tskcanvas-extension -- --with-clerk
cd tskcanvas-extension

# Set up environment
cp .env.example .env
# Edit .env with your keys

# Development
npm run dev

# Build for production
npm run build
```

### Environment Variables

```bash
# .env
PLASMO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
PLASMO_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
```

---

## Project Structure

```
tskcanvas-extension/
├── manifest.json           # Extension manifest (V3) - auto-generated by Plasmo
├── package.json
├── .env                    # Clerk & Convex keys
│
├── src/
│   ├── popup.tsx           # Main popup (Plasmo convention)
│   ├── background.ts       # Service worker (Plasmo convention)
│   │
│   └── lib/
│       ├── api.ts          # Convex API calls
│       ├── auth.ts         # Auth helpers (message passing)
│       └── tabs.ts         # Chrome tabs helpers
│
└── assets/
    ├── icon-16.png
    ├── icon-48.png
    └── icon-128.png
```

---

## Clerk Configuration

### Dashboard Setup (Required)

Configure in [Clerk Dashboard](https://dashboard.clerk.com):

1. **Add Sync Host** (Settings → Paths):
   - Domain: `tskcanvas.com`
   - Allows users signed into web app to stay signed in extension

2. **Add Extension Origin** (Settings → Domains → Allowed Origins):
   - Add: `chrome-extension://<your-extension-id>`
   - Get extension ID from `chrome://extensions` after first install

3. **Verify JWT Template** (JWT Templates):
   - Name: `convex`
   - Should already exist for main app

### Sign-in Limitations

Browser extension popups have limited sign-in options:
- ✅ Email + Password
- ✅ Email codes (OTP)
- ❌ OAuth (Google, GitHub) - popup closes during redirect
- ❌ Magic links - requires popup to stay open

**Best UX**: Enable Sync Host so users sign in once on tskcanvas.com and the extension automatically picks up their session.

---

## Implementation

### Background Service Worker

```typescript
// src/background.ts
import { createClerkClient } from '@clerk/chrome-extension';

const clerk = createClerkClient({
  publishableKey: process.env.PLASMO_PUBLIC_CLERK_PUBLISHABLE_KEY!,
  syncHost: 'https://tskcanvas.com',
});

chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.type === 'getToken') {
    clerk.session?.getToken({ template: 'convex' })
      .then((token) => sendResponse({ token }))
      .catch((error) => sendResponse({ error: error.message }));
    return true;
  }
  
  if (request.type === 'isSignedIn') {
    sendResponse({ isSignedIn: !!clerk.user });
    return false;
  }
  
  if (request.type === 'signOut') {
    clerk.signOut()
      .then(() => sendResponse({ success: true }))
      .catch((error) => sendResponse({ error: error.message }));
    return true;
  }
});

clerk.addListener(({ user }) => {
  console.log('[tskcanvas] Auth state:', user ? 'signed in' : 'signed out');
});
```

### Popup Component

```tsx
// src/popup.tsx
import { ClerkProvider, SignedIn, SignedOut, useUser, useClerk } from '@clerk/chrome-extension';
import { useState, useEffect } from 'react';
import { getAuthToken } from './lib/auth';
import { getAllTabs, type Tab } from './lib/tabs';
import { saveTabsToTree } from './lib/api';

import './popup.css';

function SignedInContent() {
  const { user } = useUser();
  const [saving, setSaving] = useState(false);
  const [tabs, setTabs] = useState<Tab[]>([]);
  const [treeName, setTreeName] = useState('');
  const [result, setResult] = useState<{ success: boolean; url?: string; error?: string } | null>(null);

  useEffect(() => {
    async function loadTabs() {
      const currentTabs = await getAllTabs();
      setTabs(currentTabs);
      setTreeName(`Saved Tabs - ${new Date().toLocaleDateString()}`);
    }
    loadTabs();
  }, []);

  const handleSave = async () => {
    setSaving(true);
    try {
      const token = await getAuthToken();
      if (!token) throw new Error('Not authenticated');
      
      const response = await saveTabsToTree(token, treeName, tabs);
      setResult({ success: true, url: response.url });
    } catch (error) {
      setResult({ success: false, error: (error as Error).message });
    }
    setSaving(false);
  };

  if (result) {
    return (
      <div className="p-4 w-80">
        {result.success ? (
          <>
            <h2 className="font-semibold text-green-600 mb-2">✓ Saved!</h2>
            <p className="text-sm mb-4">{tabs.length} tabs saved to tree.</p>
            <a
              href={result.url}
              target="_blank"
              rel="noopener noreferrer"
              className="block w-full text-center bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"
            >
              View Tree
            </a>
          </>
        ) : (
          <>
            <h2 className="font-semibold text-red-600 mb-2">Error</h2>
            <p className="text-sm text-red-500">{result.error}</p>
            <button
              onClick={() => setResult(null)}
              className="mt-4 w-full border border-gray-300 py-2 px-4 rounded hover:bg-gray-50"
            >
              Try again
            </button>
          </>
        )}
      </div>
    );
  }

  return (
    <div className="p-4 w-80">
      <div className="flex items-center justify-between mb-3">
        <h2 className="font-semibold">Save {tabs.length} tabs</h2>
        <span className="text-xs text-gray-500">{user?.primaryEmailAddress?.emailAddress}</span>
      </div>
      
      <input
        type="text"
        value={treeName}
        onChange={(e) => setTreeName(e.target.value)}
        placeholder="Tree name"
        className="w-full border rounded px-3 py-2 mb-4"
      />
      
      <div className="max-h-48 overflow-y-auto mb-4 text-sm">
        {tabs.map((tab, i) => (
          <div key={i} className="flex items-center gap-2 py-1">
            {tab.favIconUrl && (
              <img src={tab.favIconUrl} className="w-4 h-4" alt="" />
            )}
            <span className="truncate">{tab.title}</span>
          </div>
        ))}
      </div>
      
      <button
        onClick={handleSave}
        disabled={saving || tabs.length === 0}
        className="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 disabled:opacity-50"
      >
        {saving ? 'Saving...' : 'Save to tskcanvas'}
      </button>
    </div>
  );
}

function SignedOutContent() {
  const { openSignIn } = useClerk();

  return (
    <div className="p-4 w-80">
      <h2 className="font-semibold mb-2">Sign in to tskcanvas</h2>
      <p className="text-sm text-gray-600 mb-4">
        Connect your account to save tabs.
      </p>
      <button
        onClick={() => openSignIn()}
        className="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"
      >
        Sign in
      </button>
      <p className="text-xs text-gray-400 mt-3 text-center">
        Tip: Sign in at tskcanvas.com for automatic sync
      </p>
    </div>
  );
}

export default function Popup() {
  return (
    <ClerkProvider
      publishableKey={process.env.PLASMO_PUBLIC_CLERK_PUBLISHABLE_KEY!}
      syncHost="https://tskcanvas.com"
    >
      <SignedIn>
        <SignedInContent />
      </SignedIn>
      <SignedOut>
        <SignedOutContent />
      </SignedOut>
    </ClerkProvider>
  );
}
```

### Helper Functions

```typescript
// src/lib/auth.ts
export async function getAuthToken(): Promise<string | null> {
  return new Promise((resolve) => {
    chrome.runtime.sendMessage({ type: 'getToken' }, (response) => {
      if (chrome.runtime.lastError) {
        console.error('Auth error:', chrome.runtime.lastError);
        resolve(null);
        return;
      }
      if (response?.error) {
        console.error('Token error:', response.error);
        resolve(null);
      } else {
        resolve(response?.token ?? null);
      }
    });
  });
}

export async function checkIsSignedIn(): Promise<boolean> {
  return new Promise((resolve) => {
    chrome.runtime.sendMessage({ type: 'isSignedIn' }, (response) => {
      resolve(response?.isSignedIn ?? false);
    });
  });
}
```

```typescript
// src/lib/tabs.ts
export interface Tab {
  url: string;
  title: string;
  favIconUrl?: string;
}

const EXCLUDED_URL_PREFIXES = [
  'chrome://',
  'chrome-extension://',
  'edge://',
  'about:',
  'moz-extension://',
  'file://',
  'devtools://',
];

export async function getAllTabs(): Promise<Tab[]> {
  const tabs = await chrome.tabs.query({ currentWindow: true });
  
  return tabs
    .filter((tab) => {
      if (!tab.url) return false;
      return !EXCLUDED_URL_PREFIXES.some(prefix => tab.url!.startsWith(prefix));
    })
    .map((tab) => ({
      url: tab.url!,
      title: tab.title || new URL(tab.url!).hostname,
      favIconUrl: tab.favIconUrl,
    }));
}
```

```typescript
// src/lib/api.ts
const CONVEX_URL = process.env.PLASMO_PUBLIC_CONVEX_URL!;

export interface SaveTabsResponse {
  success: boolean;
  treeId: string;
  url: string;
}

export async function saveTabsToTree(
  token: string,
  treeName: string,
  tabs: Array<{ url: string; title: string; favIconUrl?: string }>
): Promise<SaveTabsResponse> {
  const response = await fetch(`${CONVEX_URL}/api/extension/save-tabs`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify({ treeName, tabs }),
  });
  
  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Failed to save tabs: ${response.status} ${errorText}`);
  }
  
  return response.json();
}
```

---

## Manifest Configuration

Plasmo generates `manifest.json` automatically. Add to `package.json`:

```json
{
  "manifest": {
    "permissions": [
      "tabs",
      "storage",
      "cookies"
    ],
    "host_permissions": [
      "https://tskcanvas.com/*",
      "https://*.convex.cloud/*",
      "https://*.clerk.accounts.dev/*"
    ]
  }
}
```

| Permission | Purpose |
|------------|---------|
| `tabs` | Query open tabs for saving |
| `storage` | Store user preferences |
| `cookies` | Required for Clerk Sync Host |

---

## Development

### Getting Extension ID

After first install (unpacked), find your extension ID:
1. Go to `chrome://extensions`
2. Enable "Developer mode"
3. Load unpacked extension (`npm run dev` output)
4. Copy the ID (looks like `abcdefghijklmnopabcdefghijklmnop`)
5. Add to Clerk Dashboard allowed origins

### Debugging

- **Popup**: Right-click extension icon → "Inspect popup"
- **Background**: `chrome://extensions` → "Inspect views: service worker"
- **Logs**: Check both popup and background consoles

### Common Issues

**"Session not found" or auth not persisting**
- Ensure `cookies` permission is in manifest
- Check Sync Host is configured in Clerk Dashboard
- Verify extension ID is in allowed origins

**Token request fails in popup**
- Use message passing to background worker (not direct `getToken()`)
- Background worker is more reliable for session management

**OAuth/Google sign-in doesn't work**
- Expected! Extension popups don't support OAuth redirects
- Use Sync Host for users to sign in on web first

---

## Implementation Phases

| Phase | Task | Hours |
|-------|------|-------|
| **1** | Setup + Clerk config | 1-2 |
| **2** | Auth implementation | 2-3 |
| **3** | Tab capture | 1 |
| **4** | UI + styling | 2-3 |
| **5** | Integration + testing | 2-3 |
| **6** | Polish + icons | 1-2 |
| **7** | Publish to Chrome Web Store | 1 |
| | **Total** | **10-15** |

---

## Publishing

### Chrome Web Store

1. Build: `npm run build`
2. Zip the `build/chrome-mv3-prod` folder
3. Go to [Chrome Web Store Developer Dashboard](https://chrome.google.com/webstore/devconsole)
4. Pay one-time $5 registration fee (if first time)
5. Upload zip and fill out listing details
6. Submit for review (1-3 days)

### Firefox Add-ons (Optional)

1. Build: `npm run build -- --target=firefox-mv2`
2. Zip the `build/firefox-mv2-prod` folder
3. Go to [Firefox Add-on Developer Hub](https://addons.mozilla.org/developers/)
4. Upload and submit

---

## Resources

- [Clerk Chrome Extension Quickstart](https://clerk.com/docs/quickstarts/chrome-extension)
- [Plasmo Documentation](https://docs.plasmo.com/)
- [Chrome Extension Manifest V3](https://developer.chrome.com/docs/extensions/mv3/intro/)
- [tskcanvas API Docs](./browser-extension-api.md)
